namespace: Chat

dialogs:
  - $import('dialog/settings.yaml')
  - $import('dialog/fileBrowser.yaml')
  - $import('dialog/queue.yaml')

# Window that displays a single conversation chat view (no conversation list).

view:
  content:
    containers:
      # Removed agents/models/tools loaders â€“ use aggregated metadata

      - id: metaLoader
        dataSourceRef: meta
        fetchData: true

      - id: header
        dataSourceRef: conversations
        fetchData: true
        selectFirst: true
        layout:
          orientation: horizontal
          columns: 5
          labelPosition: left
          gap: 2
        items:
          - id: agentName
            type: label
            label: Agent

          - id: title
            type: label
            properties:
              style:
                fontWeight: 600
            columnSpan: 3
          - id: chainStatus
            type: label
            properties:
              style:
                justifySelf: end
                alignSelf: center
                fontSize: '11px'
                fontWeight: 600
                padding: '2px 8px'
                borderRadius: '999px'
                border: '1px solid var(--light-gray1)'
                background: 'var(--light-gray5)'
                color: 'var(--gray1)'
            on:
              - event: onVisible
                handler: chat.showHeaderChainStatus

      - id: conversationSection
        chat:
          dataSourceRef: messages
          #height: 80vh
          showSettings: true
          showTools: true
          showMic: true
          commandCenter: true
          abortVisible:
            dataSourceRef: conversations
            selector: running
          # Abort button shown when DS is loading (running)
          showUpload: true
          upload:
            endpoint: agentlyAPI
            path: upload
          uploadField: files
          toolbar:
            dataSourceRef: messages
            items:
              - id: newConv
                icon: plus
                label: New Chat
                properties:
                  title: Start a new conversation
                tooltip: Start a new conversation
                enabled: true
                align: left
                on:
                  - event: onClick
                    handler: chat.newConversation
                  - event: onReadonly
                    handler: dataSource.isSelected
              - id: compact
                icon: collapse-all
                label: Compact
                properties:
                  title: Replace older history with a single summary to reduce context size
                tooltip: Replace older history with a single summary to reduce context size
                enabled: true
                align: left
                on:
                  - event: onClick
                    handler: chat.compactConversation
                  - event: onReadonly
                    handler: chat.compactReadonly
              - id: prune
                icon: trash
                label: Prune
                properties:
                  title: Remove low-value tool outputs (keeps recent context)
                tooltip: Remove low-value tool outputs (keeps recent context)
                enabled: true
                align: left
                on:
                  - event: onClick
                    handler: chat.pruneConversation
                  - event: onReadonly
                    handler: chat.pruneReadonly
              - id: queue
                icon: list
                label: Queue
                tooltip: Show queued turns
                align: left
                on:
                  - event: onClick
                    handler: window.openDialog
                    args:
                      - queue
                    parameters:
                      - name: parameters.id
                        to: queueTurns:input
                        from: conversations:form
                        location: id
              - id: visibility
                type: select
                icon: eye-open
                align: left
                dataSourceRef: conversations
                options:
                  - { value: private, label: Private }
                  - { value: public, label: Public }
                on:
                  - event: onChange
                    handler: chat.updateVisibility
              - id: toggleChains
                icon: git-branch
                label: Toggle Chains
                tooltip: Enable or disable agent chaining for new turns
                align: left
                on:
                  - event: onClick
                    handler: chat.toggleChains
                  - event: onVisible
                    handler: chat.hasAgentChains
              # Removed usage dialog trigger

          on:
            - event: onSubmit
              handler: chat.submitMessage
              parameters:
                - name: model
                  in: form
                  location: conversations.model
                - name: agent
                  in: form
                  location: conversations.agent
            - event: onSettings
              handler: chat.onSettings
            - event: onUpload
              handler: chat.onUpload
            - event: onAbort
              handler: chat.abortConversation


dataSource:
  conversations: $import('../conversations/datasource/conversations.yaml')
  messages: $import('datasource/messages.yaml')
  meta: $import('datasource/meta.yaml')
  settings: $import('datasource/settings.yaml')
  usage: $import('datasource/usage.yaml')
  fs: $import('../../filebrowser/datasource/fileBrowser.yaml')
  queueTurns: $import('dialog/datasource/queueTurns.yaml')



on:
  - event: onInit
    handler: chat.onInit
  - event: onDestroy
    handler: chat.onDestroy
